;function htmlEncode(a){return $("<div/>").text(a).html()}function htmlDecode(a){return $("<div/>").html(a).text()}function bindWriteCommentAutoresize(){$(".write_comment").autoresize({minRows:0,buffer:0,animate:!1})}function closeNewReviewPopup(){$.modal.close()}function addCommentWatermark(){$(".write_comment").watermark(ReviewText.CommentWatermark,{className:"comment-watermark",useNative:!1})}function bindReviewRatingToolTip(){$(".review-point a").each(function(){$(this).attr("tooltip")!="none"&&addRatingTooltip(this)}),$(".review-point-features a").each(function(){$(this).attr("tooltip")!="none"&&addRatingTooltip(this)})}function addRatingTooltip(a){if($(a).attr("tooltip")!="none"){var b=$(a).attr("tooltip");$("#"+b).length==0&&$("body").append('<div id="'+b+'" style="display:none" class="ratingtooltip"></div>'),$(a).tooltip({tip:"#"+b,position:"bottom center",offset:[6,0],delay:0,tipClass:"ratingtooltip",onBeforeShow:function(c,d){if($("#"+b).children().length==0){var e=$(a).attr("reviewId"),f='<div style="width:220px"><div class="top-arrow">';f+='<img src="'+staticPath+'Style/images/icons/arrow-top.png" alt="" />',f+='</div><img height="16px" src="'+staticPath+'style/images/loading.gif" /></div>',$("#"+b).append(f),populateReviewRatingTooltip(b,e)}}})}}function bindReviewRatingTooltipAjaxLoading(a){$(".review-point a[tooltip=ratingTooltip_"+a+"]").each(function(){addRatingTooltip(this)})}function populateReviewRatingTooltip(a,b){var c=new Date;$.ajax({type:"GET",url:"/Review/GetRatingTooltip?reviewId="+b+"&"+c.getTime(),success:function(b){b.success==1?$("#"+a).html(b.html):alert("error")}})}function bindTooltip(){bindingUserTooltip(),bindReviewRatingToolTip(),bindHelpfulTooltip(),bindHelpfulNameTooltip(),bindEditOrDeleteReviewTooltip(),bindPRQATooltip()}function bindHelpfulTooltipByReviewId(a,b){b==null&&(b=2),addHelpfulTooltip($('.review-helpful-link[tooltip="#helpfulTooltip_'+a+'"]')),addLikeDislikeTooltip($('.review-like-dislike-link[tooltip="#likeTooltip_'+b+"_"+a+'"]'),b),addLikeDislikeTooltip($('.review-like-dislike-link[tooltip="#dislikeTooltip_'+b+"_"+a+'"]'),b)}function bindHelpfulTooltip(){$(".review-helpful-link").each(function(){addHelpfulTooltip(this)}),$('.review-like-dislike-link[data-is-liked="true"]').each(function(){var a=$(this).data("media-type")!=undefined?$(this).data("media-type"):2;addLikeDislikeTooltip(this,a)}),$('.review-like-dislike-link[data-is-liked="false"]').each(function(){var a=$(this).data("media-type")!=undefined?$(this).data("media-type"):2;addLikeDislikeTooltip(this,a)})}function bindingUserTooltipById(a){$('a.user-link[refId="'+a+'"]').each(function(){addUserTooltip(this)}),$('a.user-link-v[refId="'+a+'"]').each(function(){addVerticalUserTooltip(this)})}function bindingUserTooltip(){$(".user-link").each(function(){addUserTooltip(this)})}function addUserTooltip(a){var b=$(a).height();b=b*-1-12;var c=$(a).attr("tooltip");$("#"+c).length==0&&$("body").append('<div id="'+c+'" style="display:none" class="tooltip"></div>'),$(a).tooltip({tip:"#"+c,position:"bottom right",offset:[b,10],delay:50,onBeforeShow:function(b,d){if($("#"+c).children().length==0){var e='<img height="16px" src="'+staticPath+'style/images/loading.gif" />';$("#"+c).append(e);var f=$(a).attr("refId");populateUserTooltip(c,f)}}})}function addVerticalUserTooltip(a){var b=$(a).width();b*=-1;var c=$(a).attr("tooltip");$("#"+c).length==0&&$("body").append('<div id="'+c+'" style="display:none" class="tooltip"></div>'),$(a).tooltip({tip:"#"+c,position:"bottom right",offset:[10,b],delay:50,onBeforeShow:function(b,d){if($("#"+c).children().length==0){var e='<img height="16px" src="'+staticPath+'style/images/loading.gif" />';$("#"+c).append(e);var f=$(a).attr("refId");populateUserTooltip(c,f,2)}}})}function populateUserTooltip(a,b,c){var d=new Date;c==null&&(c=1),$.ajax({type:"GET",url:"/Account/GetUserTooltip?userId="+b+"&"+d.getTime()+"&type="+c,success:function(b){b.success==1?$("#"+a).html(b.html):alert("error")}})}function populateHelpfulContent(a){var b='<div class="count">'+a.length+ReviewText.MemberLikes+"</div>";for(var c=0;c<a.length;c++){var d=a[c];b+='<div style="float:left; width:35px; margin-bottom:2px;">',b+="<div>",b+='<a href="'+d.UserProfileUrl+'">',b+='<img src="'+d.UserCroppedAvatarUrl+'" width="30px" height="30px" original-title="'+d.UserFirstName+'" class="helpfulUserName"/>',b+="</a>",b+="</div>",b+="</div>"}return b}function populateLikeDislikeContent(a){var b="";for(var c=0;c<a.length;c++){var d=a[c];b+='<div style="float:left; width:35px; margin-bottom:2px;">',b+="<div>",b+='<a href="'+d.UserProfileUrl+'">',b+='<img src="'+d.UserCroppedAvatarUrl+'" width="30px" height="30px" original-title="'+d.UserFirstName+'" class="helpfulUserName"/>',b+="</a>",b+="</div>",b+="</div>"}return b}function addHelpfulTooltip(a){var b=$(a).width();b*=-1,$(a).tooltip({tip:$(a).attr("tooltip"),onBeforeShow:function(b,c){var d=$(a).attr("tooltip");if($(d).is(":empty")){$(d).append('<div style="width:100%; height:6px;position: absolute; bottom: -6px; left: 0px;"></div><div class="arrow"><img src="'+staticPath+'/Style/images/icons/arrow-bottom.png" alt="" /></div><div><img height="16px" src="'+staticPath+'/style/images/loading.gif" /></div>');var e=$(a).attr("reviewId");populateHelpfulTooltip(d,e)}},position:"top right",offset:[-5,b],delay:5})}function addLikeDislikeTooltip(a,b){var c=$(a).width();c*=-1,$(a).tooltip({tip:$(a).attr("tooltip"),onBeforeShow:function(c,d){var e=$(a).attr("tooltip");if($(e).is(":empty")){$(e).append('<div style="width:100%; height:6px;position: absolute; bottom: -6px; left: 0px;"></div><div class="arrow"><img src="'+staticPath+'/Style/images/icons/arrow-bottom.png" alt="" /></div><div><img height="16px" src="'+staticPath+'/style/images/loading.gif" /></div>');var f=$(a).attr("reviewId"),g=$(a).data("is-liked");populateLikeDislikeTooltip(e,f,g,b)}},position:"top right",offset:[-5,c],delay:5})}function showCommentTextBox(a,b){var c=new Date;$.ajax({type:"GET",url:"/Review/IsLogin?"+c.getTime(),success:function(c){c.success==1?prepareToWriteComment(a,c.avatar,c.currentUserProfileUrl,b):LoginPopup.Show(function(){closeNewReviewPopup(),prepareToWriteComment(a,c.avatar,c.currentUserProfileUrl,b)})}})}function prepareToWriteComment(a,b,c,d){$("#review_comment_id_"+d+"_"+a+" .review-reply-item-avatar img").attr("src",b),$("#review_comment_id_"+d+"_"+a+" .review-reply-item-avatar a").attr("href",c),$("#review_comment_id_"+d+"_"+a).css("display","block");var e=$("#write_comment_"+d+"_"+a).offset().top,f=$(window).height();e>f/2&&(e-=f/2),$("body,html").animate({scrollTop:e},500),$("#write_comment_"+d+"_"+a).focus()}function addComment(a,b){var c=b.keyCode,d=0;d=b.shiftKey;if(c!=13||!!d)return!0;b.preventDefault?b.preventDefault():b.returnValue=!1;if(isSubmittingComment==0){var e=$(a).attr("reviewId"),f=$.trim($(a).val());return f!=""&&(isSubmittingComment=!0,$.ajax({type:"POST",url:"/Review/AddComment",data:{reviewId:e,comment:htmlEncode(f)},success:function(a){a.success&&($("#write_comment_"+e).css("height","15px"),$("#write_comment_"+e).val(""),$("#commentBox_"+e).append(a.html),updateTotalComment(e),$('div[reviewId="'+e+'"] .review-reply-item .user-link').each(function(){addUserTooltip(this)}),bindCommentPostedTime(e),isSubmittingComment=!1,PointNotify.AddedPointNotify(a.TotalPendingPoints))}})),!1}}function updateTotalComment(a,b){var c="#comment_count_"+b+"_"+a,d=parseInt($(c).text());d++,$(c).text(d)}function addThanks(a){var b=new Date;$(".helpful-wating").show(),$.ajax({type:"GET",url:"/Common/IsLogin?"+b.getTime(),success:function(b){if(b.success==1){var c=$(a).attr("reviewId");prepareForAddThanks(c)}else LoginPopup.Show(function(){var b=$(a).attr("reviewId");closeNewReviewPopup(),prepareForAddThanks(b)},function(){$(".helpful-wating").hide()})}})}function addLikeDislike(a,b,c){var d=new Date;$(".helpful-wating").show(),$.ajax({type:"GET",url:"/Common/IsLogin?"+d.getTime(),success:function(d){if(d.success==1){var f=$(a).attr("reviewId");prepareForAddLikeDislike(f,b,c)}else LoginPopup.Show(function(){var d=$(a).attr("reviewId");closeNewReviewPopup(),prepareForAddLikeDislike(d,b,c)},function(){$(".helpful-wating").hide()})}})}function populateHelpfulTooltip(a,b){var c=new Date;$.ajax({type:"GET",url:"/Review/ListHelpfulUsers?reviewId="+b+"&"+c.getTime(),success:function(b){if(b.success==1){if(b.data!=null){var c='<div style="width:100%; height:6px;position: absolute; bottom: -6px; left: 0px;"></div><div class="arrow"><img src="'+staticPath+'/Style/images/icons/arrow-bottom.png" alt="" /></div>';b.data.HelpfulUsers.length>0?c+=populateHelpfulContent(b.data.HelpfulUsers):c+='<div class="count">'+ReviewText.BeTheFirstLike+"</div>",c+='<div class="helpful-wating" style="display: none;">',c+='<img src="'+staticPath+'Style/images/icons/ajax-loader.gif" />',c+="</div> ";var d=$(a).height();$(a).html(c),$(a).height()>d&&$(a).css("top",parseInt($(a).css("top"))-($(a).height()-d)),bindHelpfulNameTooltip()}}else alert("error")}})}function populateLikeDislikeTooltip(a,b,c,d){var e=new Date;$.ajax({type:"GET",url:"/Review/ListLikeDislikeUsers?reviewId="+b+"&isLiked="+c+"&type="+d+"&"+e.getTime(),success:function(b){if(b.success==1){if(b.data!=null){var c='<div style="width:100%; height:6px;position: absolute; bottom: -6px; left: 0px;"></div><div class="arrow"><img src="'+staticPath+'/Style/images/icons/arrow-bottom.png" alt="" /></div>';b.data.HelpfulUsers.length>0?c+=populateLikeDislikeContent(b.data.HelpfulUsers):c+='<div class="count">Chưa có thành viên nào.</div>',c+='<div class="helpful-wating" style="display: none;">',c+='<img src="'+staticPath+'Style/images/icons/ajax-loader.gif" />',c+="</div> ";var d=$(a).height();$(a).html(c),$(a).height()>d&&$(a).css("top",parseInt($(a).css("top"))-($(a).height()-d)),bindHelpfulNameTooltip()}}else alert("error")}})}function prepareForAddThanks(a){var b=new Date;$.ajax({type:"GET",url:"/Review/AddReviewFavourite?reviewId="+a+"&"+b.getTime(),success:function(b){if(b.success==1){$("#totalThanks_id_"+a).text(b.totalFavourites),$('a.review-helpful-link[reviewId="'+a+'"]').effect("highlight",{},3e3);var c=$('a.review-helpful-link[reviewId="'+a+'"]').attr("tooltip");populateHelpfulTooltip(c,a),PointNotify.AddedPointNotify(b.TotalPendingPoints)}$(".helpful-wating").hide()}})}function prepareForAddLikeDislike(a,b,c){var d=new Date;$.ajax({type:"GET",url:"/LikeComment/AddLikeDislike?referenceId="+a+"&type="+c+"&isLiked="+b+"&"+d.getTime(),success:function(d){if(d.success==1){var e="";$("#totalLikes_id_"+c+"_"+a).text(d.result.TotalLikes),$("#totalDislikes_id_"+c+"_"+a).text(d.result.TotalDislikes),$("#totalLikes_id_"+c+"_"+a).parent().parent().removeClass("active"),$("#totalDislikes_id_"+c+"_"+a).parent().parent().removeClass("active"),d.result.HasLiked?$("#totalLikes_id_"+c+"_"+a).parent().parent().addClass("active"):d.result.HasDisliked&&$("#totalDislikes_id_"+c+"_"+a).parent().parent().addClass("active");var f='.review-like-dislike-link[tooltip="#likeTooltip_'+c+"_"+a+'"]',g='.review-like-dislike-link[tooltip="#dislikeTooltip_'+c+"_"+a+'"]';b?e=f:e=g,$(e).effect("highlight",{},3e3),b?(populateLikeDislikeTooltip($(g).attr("tooltip"),a,!b,c),populateLikeDislikeTooltip($(f).attr("tooltip"),a,b,c)):(populateLikeDislikeTooltip($(f).attr("tooltip"),a,!b,c),populateLikeDislikeTooltip($(g).attr("tooltip"),a,b,c))}$(".helpful-wating").hide()}})}function showAllComments(a,b){var c="/Review/ListAllCommentsByReview?reviewId="+a;$("#commentBox_"+a).load(c,function(){$("#commentBox_"+a+" .user-link").each(function(){addUserTooltip(this)}),bindCommentPostedTime(a),$(b).closest(".view-all-comments").hide()})}function loadUserTotalReviews(a){var b=$("#userReviews_"+a).attr("userreviews");$('div.status[userreviews="'+b+'"]').text($('div.status[userreviews="'+b+'"]:eq(0)').text())}function IncreaseGlobalTotalReview(a){var b=",";$("#global-total-reviews").text().indexOf(",")==-1&&(b=".");var c=parseInt($("#global-total-reviews").text().replace(b,""))+a;$("#global-total-reviews").text(addCommas(c,b))}function addCommas(a,b){a+="",x=a.split("."),x1=x[0],x2=x.length>1?"."+x[1]:"";var c=/(\d+)(\d{3})/;while(c.test(x1))x1=x1.replace(c,"$1"+b+"$2");return x1+x2}function updateTotalUserReviewsAndPictures(a){var b=$('div.review-item[reviewId="'+a+'"] span[userreviews]').attr("userreviews"),c=$('div.review-item[reviewId="'+a+'"] span[userpictures]').attr("userpictures"),d=$('div.review-item[reviewId="'+a+'"] span[userreviews]').first().text(),e=$('div.review-item[reviewId="'+a+'"] span[userpictures]').first().text();$('div.status[userreviews="'+b+'"]').text(d+" bình luận"),$('span[userreviews="'+b+'"]').text(d),$('span[userpictures="'+c+'"]').text(e)}function updateTotalReviewsAndPicturesByUsername(a,b,c){$('span[userreviews="userReviews_'+a+'"]').text(b),$('span[userpictures="userPictures_'+a+'"]').text(c),$('div.status[userreviews="userReviews_'+a+'"]').text(b+" "+ReviewText.Review)}function bindHelpfulNameTooltip(){$("img.helpfulUserName").tipsy({gravity:"s"})}function RemoveReviewByIndex(a){var b=$(".micro-home-recent-review.review-item");if(b.length>=a&&a>0){var c=b[a-1];$(c).remove()}}function ScrollToReview(a){var b=0,c=$("#review-"+a).children().first();b=$(c).position().top;if(b>0)$("body,html").animate({scrollTop:b},800),$(c).effect("highlight",{},3e3);else var d=setInterval(function(){c=$("#review-"+a).children().first(),b=$(c).position().top,b>0&&(clearInterval(d),$("body,html").animate({scrollTop:b},800),$(c).effect("highlight",{},3e3))},200)}function LoadReviewSummaryBox(a){if($("#reviewSummaryDiv").length>0){$("#reviewSummaryDiv").show();var b=new Date,c="/Review/GetReviewSummary?restaurantId="+a;typeof hasFiltered!="undefined"&&hasFiltered!=null&&hasFiltered&&(c+="&hasFiltered=true"),c+="&"+b.getTime(),$("#reviewSummaryDiv").load(c,function(){$(".res-common-rating-number a").text($(".micro-home-point .micro-home-points").text())}),$.get("/restaurant/GetPointSummary?restaurantid="+a+"&t="+b.getTime(),function(a){a.success&&$("#res-summary-point").html(a.html)})}}function GetModifiedReview(a){if(typeof reviewtemplate=="undefined"||reviewtemplate==null)reviewtemplate=1;var b=new Date,c="";isReviewDetailPage?c="/Review/GetReview?t="+b.getTime()+"&reviewId="+a+"&template="+reviewtemplate:c="/Review/GetReviewById?t="+b.getTime()+"&reviewId="+a+"&template="+reviewtemplate,$.get(c,function(b){var c=!0;isReviewDetailPage?$("#review-"+a).empty().append(b):(c=b.success,c&&(typeof homeReviewsModel!="undefined"&&homeReviewsModel!=null&&homeReviewsModel.replaceReview(b.data),typeof resReviewsModel!="undefined"&&resReviewsModel!=null&&resReviewsModel.replaceReview(b.data))),b.userid!=null&&removeUserTooltip(b.userid),c&&($("#ratingTooltip_"+a).remove(),bindTooltip(),bindPostedTime(a),updateTotalUserReviewsAndPictures(a),addCommentWatermark(),ScrollToReview(a),bindReviewReportByReviewId(a),hideLoadingProcess(),closeNewReviewPopup(),drawChart())})}function UpdateMicrositePictures(a,b){$.post("/Gallery/GetRestaurantStatistic?restaurantId="+a,function(a){var c=a.data;if(c.length>0){var d=0,e="";$.each(c,function(a,c){if(c.Counts>0){d+=c.Counts;var f=b;e+='<div class="micro-home-album"><div class="img-'+c.UrlRewriteName+'">'+'<a href="'+f+'">'+'<img src="'+c.DefaultImageUrl+'"/>'+"</a>"+"</div>"+'<div class="album">'+'<a href="'+f+'">'+c.Name+"</a></div>"+'<div class="by"><span class="pics-'+c.UrlRewriteName+'-countable">'+c.Counts+"</span> "+Text.photo+"</div>"+"</div>",$(".pics-"+c.UrlRewriteName+"-countable").html(c.Counts),$(".pics-"+c.UrlRewriteName+"-countable1").html("("+c.Counts+")")}}),$(".predefine-album-box").html(e),$(".pics-countable").html(d)}}),$.get("/Gallery/RestaurantFeatureGallery?restaurantId="+a+"&restaurantName=",function(a){$(".feature-gallery").html(a)})}function bindEditOrDeleteReviewTooltip(){$("a.review-modified").tipsy({gravity:"s",live:!0}),$("a.review-deleted").tipsy({gravity:"s",live:!0})}function addRestaurantChecked(a){var b=new Date;$(".checkin-restaurant-waiting").show(),$.ajax({type:"GET",url:"/Common/IsLogin?"+b.getTime(),success:function(b){if(b.success==1){var c=$(a).attr("resId");prepareForAddRestaurantCheckIn(c)}else LoginPopup.Show(function(){var b=$(a).attr("resId");closeNewReviewPopup(),prepareForAddRestaurantCheckIn(b)},function(){$(".checkin-restaurant-waiting").hide()})}})}function prepareForAddRestaurantCheckIn(a){var b=new Date;$.ajax({type:"GET",url:"/Restaurant/AddCheckIn?restaurantId="+a+"&"+b.getTime(),success:function(a){$(".checkin-restaurant-waiting").hide();if(a.success==1)$(".from-review .count-checkedin").text(a.totalCheckedIn),$(".restaurant_checkin").removeClass("checkin").addClass("checkin_act");else switch(a.errorType){case 1:alert("Bạn chưa đăng nhập");break;case 4:$(".restaurant_checkin.checkin").removeClass("checkin").addClass("checkin_act"),alert(CommonText.AlreadyCheckin)}}})}function updateRestaurantCheckedInStatus(){var a=$(".restaurant_checkin").attr("resId");if(a!=null){var b=new Date;$.ajax({type:"GET",url:"/Restaurant/IsCheckedIn?restaurantId="+a+"&"+b.getTime(),success:function(a){if(a.success==1)a.canchecked?$(".restaurant_checkin.checkin_act").removeClass("checkin_act").addClass("checkin"):$(".restaurant_checkin.checkin").removeClass("checkin").addClass("checkin_act");else switch(a.errorType){case 1:alert(ReviewText.NotLogin)}}})}}function LoadBreadCrumb(){var a=!0,b=!1,c=!1,d=new Date;$.get("/Review/GetReviewStatistic?isreview="+a+"&ispr="+b+"&isqa="+c+"&d="+d.getTime(),function(a){if(a.success){var b=a.data;$('#breadcrumddl [refval=""] > span').text(addCommas(b.TotalReviews,",")),$('#breadcrumddl [refval="nha-hang"] > span').text(addCommas(b.ResTotalReviews,",")),$('#breadcrumddl [refval="quan-an"] > span').text(addCommas(b.QuanAnTotalReviews,",")),$('#breadcrumddl [refval="cafe"] > span').text(addCommas(b.CafeTotalReviews,",")),$('#breadcrumddl [refval="tiem-banh"]>span').text(addCommas(b.TiemBanhTotalReviews,",")),$('#breadcrumddl [refval="bar-pub"]>span').text(addCommas(b.BarTotalReviews,",")),$('#breadcrumddl [refval="karaoke"]>span').text(addCommas(b.KaraokeTotalReviews,",")),$('#breadcrumddl [refval="khu-du-lich"]>span').text(addCommas(b.ResortTotalReviews,",")),$('#breadcrumddl [refval="billiards"]>span').text(addCommas(b.BillardTotalReviews,",")),$('#breadcrumddl [refval="tiec-cuoi-hoi-nghi"]>span').text(addCommas(b.EventTotalReviews,",")),$('#breadcrumddl [refval="cua-hang"]>span').text(addCommas(b.StoreTotalReviews,",")),$('#breadcrumddl [refval="an-vat-via-he"]>span').text(addCommas(b.AnVatViaHeTotalReviews,",")),$('#breadcrumddl [refval="sang-trong"]>span').text(addCommas(b.SangTrongTotalReviews,",")),$('#breadcrumddl [refval="giai-tri"]>span').text(addCommas(b.GiaiTriTotalReviews,",")),$('#breadcrumddl [refval="spa-massage"]>span').text(addCommas(b.SpaMassageTotalReviews,",")),$('#breadcrumddl [refval="hotel"]>span').text(addCommas(b.HotelTotalReviews,","))}})}function bindPRQATooltip(){$(".review-pr").tipsy({gravity:"s"}),$(".review-qa").tipsy({gravity:"s"})}function bindReviewReportErrorWithoutLogined(){$("a.review-report-error").live("click",function(){loginForReviewReportSuccess(this)})}function loginForReviewReportSuccess(a){LoginPopup.Show(function(){$.modal.close(),bindReviewReportErrorWithLogined(),$("body,html").animate({scrollTop:$(a).position().top},800),$(a).effect("highlight",{},3e3),setTimeout(function(){$(a).click()},1e3)})}function bindReviewReportItem(a){var b=$(a).attr("reviewid"),c=$(a).data("media-type");$(a).qtip({content:" ",show:{event:"click"},position:{my:"top center",at:"bottom center"},hide:{event:"unfocus",fixed:!0},events:{show:function(a,d){var e=$("#review-report-dialog");e.length&&d.set("content.text",e),$("#review-error-hd").val(b),$("#review-error-type").val(c),$("#review-report-dialog .correctinfotextbox").val(""),$("#review-report-dialog .report-success").empty(),$("#review-report-dialog .report-fail").empty(),$("#review-report-dialog .correctinfotextbox").watermark(CommonText.InformationWatermark,{className:"comment-watermark"})}}})}function bindReviewReportByReviewId(a){isLogin&&bindReviewReportItem($("#review-"+a+" .review-report-error"))}function bindReviewReportErrorWithLogined(){$(function(){isLogin=!0,$("a.review-report-error").die("click"),$("a.review-report-error").live("click",function(){return!1}),$("a.review-report-error").each(function(){bindReviewReportItem(this)}),$("#review-report-dialog .send-resinfo-error").live("click",function(){if($.trim($("#review-report-dialog .correctinfotextbox").val())!=""){var a={reviewId:$("#review-error-hd").val(),type:$("#review-error-type").val(),errorkeyname:$("#review-report-dialog .errorkeyname").text(),correctinfo:$("#review-report-dialog .correctinfotextbox").val(),istrue:!1,reporturl:window.location.href};postReviewReport(a,"#review-report-dialog")}else $("#review-report-dialog .report-fail").text(CommonText.PlsInputInfor),$("#review-report-dialog .report-success").text("")})})}function postReviewReport(a,b){$(b+" .report-wating").show(),$.post("/Review/AddReportError",a,function(a){a.success?($(b+" .report-wating").hide(),$(b+" .report-success").text("Cám ơn bạn"),$(b+" .report-fail").text(""),$(b+" .correctinfotextbox").val("")):alert(a.errorType)})}function getCurrentPageIndex(){var a=getFilterTabType(),b=0;switch(a){case 1:b=scrollPageIndex;break;case 2:b=prPageIndex;break;case 3:b=qnaPageIndex;break;default:b=scrollPageIndex}return b}function increaseCurrentPageIndex(){var a=getFilterTabType(),b=0;switch(a){case 1:scrollPageIndex++;break;case 2:prPageIndex++;break;case 3:qnaPageIndex++;break;default:scrollPageIndex++}}function getTotalItem(){var a=getFilterTabType(),b=0;switch(a){case 1:b=totalReviews;break;case 2:getCurrentPageIndex()==0?b=100:b=totalPRs;break;case 3:getCurrentPageIndex()==0?b=100:b=totalQAs;break;default:b=totalReviews}return b}function setTotalItem(a){var b=getFilterTabType();switch(b){case 1:totalReviews=a;break;case 2:totalPRs=a;break;case 3:totalQAs=a;break;default:totalReviews=a}}function getItemContainer(){var a=getFilterTabType(),b="#review-list";switch(a){case 1:b="#review-list";break;case 2:b="#pr-list";break;case 3:b="#qna-list";break;default:b="#review-list"}return b}function updateFilterTitle(){var a=getFilterTabType(),b=CommonText.review;switch(a){case 1:b=CommonText.review;break;case 2:b=CommonText.PRLower;break;case 3:b=CommonText.QALower;break;case 4:b=CommonText.CheckinLower;break;default:b=CommonText.review}$("#filter-title").text(b)}function setEmptyDivPane(){var a=getFilterTabType();switch(a){case 1:$("#review-list").html('<div class="micro-home-recent-review review-item empty">'+ReviewText.HaveNoReview+"</div>");break;case 2:$("#pr-list").html('<div class="micro-home-recent-review review-item empty">'+ReviewText.HaveNoPR+"</div>");break;case 3:$("#qna-list").html('<div class="micro-home-recent-review review-item empty">'+ReviewText.HaveNoQA+"</div>");break;default:$("#review-list").html('<div class="micro-home-recent-review review-item empty">'+ReviewText.HaveNoReview+"</div>")}}function getFilterTabType(){var a=parseInt($("ul.review-tabs > li > a.current").closest("li").attr("type"));return a}function updateReviewTabs(a){$("ul.review-tabs li a").removeClass("current"),$("a",a).addClass("current"),$("div.micro-reviews > div.tab-panes > div").hide(),$($(a).data("tabcontent")).show(),updateFilterTitle()}function deleteComment(a){if(confirm(Text.MsgConfirmDeletePhotoComment)==1){var b=$(a).attr("commentId");b!=null&&b!=0&&$.post("/Review/RemoveComment",{commentId:b},function(b){b.Success&&$(a).closest(".review-reply-item").remove()})}}function IsFiltering(){if($("#ddlCriteria").val()!=null&&$("#ddlLevel").val()!=null&&$("#ddlOrderByTime").val()!=null)if($("#ddlCriteria").val()!="0"||$("#ddlLevel").val()!="0"||$("#ddlOrderByTime").val()!="true")return!0;return!1}function RecookComment(a){return a.IsLiked=ko.observable(a.IsLiked),a.TotalLike=ko.observable(a.TotalLike),a}function RecookReviews(a,b){var c=new Array;for(var d=0;d<a.length;d++){var e=new GroupItem(a[d]);if(b==1&&a[d].ReviewType==4&&(a[d].Comment==null||a[d].Comment=="")&&a[d].TotalPictures==0){var f=d+1;while(f<a.length&&a[f].ReviewType==4)e.items.push(a[f]),f++;f>d+1&&(e.type=5,d=f-1)}c.push(e)}return c}function resetFiltering(a){$("#ddlCriteria").val(0),$("#ddlLevel").val(0),$("#ddlOrderByTime").val(!0)}function removeUserTooltip(a){$("#userTooltip_"+a).remove(),$("#userTooltip_v_"+a).remove()}function updateRestaurantSummaryCanView(){$(".btn-sum-detail").hide(),$(".microsite-box-rating-new").css("opacity",1)}function insertHomeReviewAds(a,b){$(a).insertAfter($("#review-list>div.nonads:nth("+b+")")),$(a).show()}function selectAndInsertHomeReviewAds(a){var b=$(".ads-banner.hide:nth(0)");b&&($(b).removeClass("hide").addClass("added"),insertHomeReviewAds(b,a))}function autoInsertReviewAds(){setTimeout(function(){var a=$("#review-list>div.nonads").length,b=$("#review-list>div.ads-banner.added").length,c=$(".ads-banner.hide").length;while(a>(b+1)*insertAdsRate&&c>0)selectAndInsertHomeReviewAds((b+1)*insertAdsRate-1),b=$("#review-list>div.ads-banner.added").length,c=$(".ads-banner.hide").length},500)}function addMobileTooltip(a){if($(a).attr("tooltip")!="none"){var b=$(this).width();b*=-1;var c=$(a).attr("tooltip");$(a).tooltip({tip:"#"+c,position:"bottom center",offset:[6,0],delay:50,tipClass:"mobileapptooltip"})}}function bindReviewMoblieTooltip(a){$("#review-"+a+" a.viamobile").each(function(){addMobileTooltip(this)}),$("#checkin-"+a+" a.viamobile").each(function(){addMobileTooltip(this)})}function GetMediaType(a){var b=-1;return a==4?b=11:b=2,b}typeof staticPath=="undefined"&&(staticPath="");var loginSuccessCallback;$(function(){$("a.remove-review-comment").live("click",function(a){deleteComment(this)})}),$(".link-to-facebook").live("click",function(){var a=$(this).attr("resid");LinkToFacebook(function(){closeNewReviewPopup(),UploadReview.LoadAddNewReviewForm(a)})}),$(".checkin-link-to-facebook").live("click",function(){LinkToFacebook(function(){$("#checkin-facebook-share .unshare_facebook").hide(),$("#checkin-facebook-share .share_facebook").show(),$("#checkin-share-facebook-check span.checkbox").addClass("check"),$("#checkin_hdshareOnFacebook").val(!0),$("#checkin_hdhasShareOnFacebook").val(!0)})});var isSubmittingComment=!1;$("a.review-modified").live("click",function(){var a=$(this).attr("restaurantId"),b=$(this).attr("reviewId");return UploadReview.LoadModifiedReviewForm(b,a),!1});var isReviewDetailPage=!1;$("a.review-deleted").live("click",function(){if(confirm(ReviewText.DeleteConfirmMsg)){var a=$(this).attr("reviewId"),b=$(this).attr("restaurantId"),c=$(this).attr("returnUrl"),d=new Date;$(".tipsy").remove(),$.ajax({type:"GET",url:"/Review/UpdateReviewAsTrash?reviewId="+a+"&"+d.getTime(),success:function(d){if(d.Success)$("#review-"+a).remove(),isReviewPage?(typeof homeReviewsModel!="undefined"&&homeReviewsModel!=null&&homeReviewsModel.removeReview(a),typeof resReviewsModel!="undefined"&&resReviewsModel!=null&&resReviewsModel.removeReview(a),updateTotalReviewsAndPicturesByUsername(d.Statistic.UserName,d.Statistic.TotalReviews,d.Statistic.TotalPictures),LoadReviewSummaryBox(b),UpdateMicrositePictures(b,c),getFilterTabType()==1&&IncreaseGlobalTotalReview(-1)):window.location=c+"/binh-luan",PointNotify.RemovedPointNotify(d.TotalRemovedPoints);else switch(d.ErrorType){case 3:alert(ReviewText.NotLogin);break;case 1:alert(ReviewText.CannotDeleteIfNotOwner);break;case 2:alert(ReviewText.DeleteTimeIsOver);break;case 4:alert(ReviewText.CannotDeleteIfApproved)}}})}return!1}),$(".restaurant_checkin").live("click",function(){return addRestaurantChecked(this),!1});var isLogin=!1;window.onpopstate=function(a){a.state&&updateReviewTabs($('ul.review-tabs li[data-tabcontent="'+a.state.tab+'"]'))};var ListReviewsModel=function(a){var b=this;isLogin=a.IsLogin,isLogin||bindReviewReportErrorWithoutLogined(),b.count=a.Count,b.total=ko.observable(a.Total),b.totalRemaining=ko.observable(a.Total-b.count),b.lastId=a.LastId,b.currentTimestamp=a.CurrentTimestamp,currentTimeStamp=a.CurrentTimestamp,b.reviews=ko.observableArray(RecookReviews(a.Reviews,!0)),b.isReview=ko.observable(!0),b.isPR=ko.observable(!1),b.isQA=ko.observable(!1),b.isCheckin=ko.observable(!1),b.categoryId=ko.observable(0),b.categoryUrlRewriteName=ko.observable(""),b.provinceId=ko.observable(a.ProvinceId),b.isPaging=!0,b.isLoading=ko.observable(!1),b.showContinue=ko.observable(!1),b.currentUserUrl=ko.observable(a.CurrentUserProfileUrl),b.currentUserAvatar=ko.observable(a.CurrentUserAvatar),a.ViewedUserId!=null&&(b.userId=ko.observable(a.ViewedUserId)),b.resId=a.ResId,b.hasFiltered=a.HasFiltered,b.resUrl=a.ResUrl,b.resName=ko.observable(a.ResName),b.criteria=ko.observable(0),b.level=ko.observable(0),b.orderByTime=ko.observable(!0),b.isRecommended=ko.observable(a.IsRecommended),b.fullTotal=ko.observable(a.FullTotal),b.reviewTabClick=function(a,c){c.preventDefault(),b.isReview(!1),b.isPR(!1),b.isQA(!1),b.isCheckin(!1),updateReviewTabs(c.currentTarget);var d=$(c.currentTarget).attr("data-tabcontent"),e="",f=reviewUrl;switch(d){case"#review-tab":f=reviewUrl+"/binh-luan/"+userNameUrlPart,e=window.location.hash,e!=""&&(f+=e),b.isReview(!0);break;case"#pr-tab":f=reviewUrl+"/quang-cao/"+userNameUrlPart,b.isPR(!0),b.reviewPRs()==null&&b.loadReviews(!1,2);break;case"#qna-tab":f=reviewUrl+"/hoi-dap/"+userNameUrlPart,b.isQA(!0),b.reviewQAs()==null&&b.loadReviews(!1,2);break;case"#checkin-tab":f=reviewUrl+"/check-in/"+userNameUrlPart,b.isCheckin(!0),b.checkins()==null&&b.loadReviews(!1,2)}typeof window.history!="undefined"&&window.history.pushState({tab:d+e},document.title,f)},b.reviewPRs=ko.observableArray(null),b.totalPRs=ko.observable(a.TotalPRReviews),b.totalPRRemaining=ko.observable(0),b.lastPRId=0,b.reviewQAs=ko.observableArray(null),b.totalQAs=ko.observable(a.TotalQAReviews),b.totalQARemaining=ko.observable(0),b.lastQAId=0,b.checkins=ko.observableArray(null),b.totalCheckins=ko.observable(a.TotalCheckins),b.totalCheckinRemaining=ko.observable(0),b.lastCheckinId=0,b.filterClick=function(a){switch(a){case"review":b.isReview(!b.isReview()),b.loadReviews(!1);break;case"pr":b.isPR(!b.isPR()),b.loadReviews(!1);break;case"qa":b.isQA(!b.isQA()),b.loadReviews(!1)}},b.afterRenderCommentCallback=function(a,c){bindingUserTooltipById(c.OwnerId),bindCommentPostedTime(c.ReviewId),b.emojiReplace($(a[1]).find(".review-reply-item-content>span.comment"))},b.aferRenderReviewItemCallback=function(a,c){c.AvgRating!="0.0"&&bindReviewRatingTooltipAjaxLoading(c.Id),b.emojiReplace($(a[1]).find(".title>a")),b.emojiReplace($(a[1]).find("div.desc")),bindAutoResize(c.Id),bindCommentWatermark(c.Id),bindUserTooltipAjaxLoading(c.Id),bindPostedTime(c.Id),bindEditOrDeleteReviewTooltip(),bindPRQATooltip(),bindReviewReportByReviewId(c.Id),bindReviewContentExpander(),bindHelpfulTooltipByReviewId(c.Id,GetMediaType(c.ReviewType)),bindHelpfulNameTooltip(),bindingUserTooltipById(c.OwnerId),bindCommentPostedTime(c.Id),bindReviewMoblieTooltip(c.Id),$(".reviews-main-item").length<(numberScrollablePage+1)*b.count&&$(".reviews-main-item").length>0?b.showContinue(!1):b.showContinue(!0),$(".user-reviews.review-item").length<(numberScrollablePage+1)*b.count&&$(".user-reviews.review-item").length>0?b.showContinue(!1):b.showContinue(!0)},b.emojiReplace=function(a){if(a!=null&&a.length>0){var b=$(a).html();b=jEmoji.unifiedToHTML(b),$(a).html(b)}},b.afterRenderPicturesCallback=function(a,b){var c=b;switch(c.Template){case"SinglePictureView":case"DoublePictureView":case"TriplePictureView":case"NormalPictureView":case"PortraitPictureView":$(".review-img-"+c.Pictures.Items[0].ReviewID).foodybox();break;case"LandscapePictureView":$(".review-img-"+c.Pictures.Items[0].ReviewID).foodybox(),$(".show-pic-"+c.Pictures.Items[0].ReviewID).click(function(a){a.preventDefault();var b=$(".review-img-"+c.Pictures.Items[0].ReviewID).first();b.click()})}},b.pictureNormalMaxIndex=11,b.picturePortraitMaxIndex=2,b.pictureLandscapeMaxIndex=2,b.getLoadLink=function(a,c){var d=new Date,e="";switch(c){case 1:e="/review/gethomereviews?t="+d.getTime()+"&provinceId="+b.provinceId(),b.categoryUrlRewriteName()!=null&&b.categoryUrlRewriteName()!=0&&(e+="&categoryUrlRewriteName="+b.categoryUrlRewriteName()),b.lastId!=null&&b.lastId!=0&&a&&(e+="&lastId="+b.lastId);break;case 2:e="/review/getresreviews?t="+d.getTime()+"&resId="+b.resId,!b.isQA()&&!b.isPR()&&!b.isCheckin()?(e+="&criteria="+b.criteria(),e+="&level="+b.level(),e+="&orderAscByTime="+b.orderByTime(),e+="&isRecommended="+b.isRecommended(),b.lastId!=null&&b.lastId!=0&&a&&(e+="&lastId="+b.lastId)):b.isQA()?b.lastQAId!=null&&b.lastQAId!=0&&a&&(e+="&lastId="+b.lastQAId):b.isPR()?b.lastPRId!=null&&b.lastPRId!=0&&a&&(e+="&lastId="+b.lastPRId):b.isCheckin()&&(e="/review/GetResCheckins?t="+d.getTime()+"&resId="+b.resId+(userNameUrlPart!=undefined&&userNameUrlPart!=null&&userNameUrlPart!=""?"&userName="+userNameUrlPart:""),b.lastCheckinId!=null&&b.lastCheckinId!=0&&a&&(e+="&lastId="+b.lastCheckinId));break;case 3:e="/review/getuserreviews?t="+d.getTime()+"&userid="+b.userId(),b.lastId!=null&&b.lastId!=0&&a&&(e+="&lastId="+b.lastId)}return b.isReview()?e+="&isreview=true":e+="&isreview=false",b.isPR()?e+="&ispr=true":e+="&ispr=false",b.isQA()?e+="&isqa=true":e+="&isqa=false",e},b.loadReviews=function(a,c){var d=b.totalRemaining();c==2&&(b.isPR()?d=b.totalPRRemaining():b.isQA()?d=b.totalQARemaining():b.isCheckin()&&(d=b.totalCheckinRemaining())),c!=3;if(!b.isLoading()&&d>0&&a||!a&&!b.isLoading()){b.isLoading(!0),b.showContinue(!1),c==null&&(c=1);var e=b.getLoadLink(a,c);b.isPaging=a,$.get(e,function(d){if(d.success){var e=d.data,f=null;b.isCheckin()?f=RecookReviews(e.Checkins,!1):f=RecookReviews(e.Reviews,!0);if(a){if(c==1||c==2&&!b.isPR()&&!b.isQA()&&!b.isCheckin()||c==3){for(var g=0;g<f.length;g++)b.reviews.push(f[g]);b.lastId=e.LastId,b.totalRemaining(e.Total-b.count),autoInsertReviewAds()}else if(b.isPR()){for(var g=0;g<f.length;g++)b.reviewPRs.push(f[g]);b.lastPRId=e.LastId,b.totalPRRemaining(e.Total-b.count)}else if(b.isQA()){for(var g=0;g<f.length;g++)b.reviewQAs.push(f[g]);b.lastQAId=e.LastId,b.totalQARemaining(e.Total-b.count)}else if(b.isCheckin()){for(var g=0;g<f.length;g++)b.checkins.push(f[g]);b.lastCheckinId=e.LastId,b.totalCheckinRemaining(e.Total-b.count)}b.isLoading(!1),b.currentUserAvatar(e.CurrentUserAvatar),b.currentUserUrl(e.CurrentUserProfileUrl)}else c==1||c==2&&!b.isPR()&&!b.isQA()&&!b.isCheckin()||c==3?(b.reviews(f),b.lastId=e.LastId,b.total(e.Total),b.totalRemaining(e.Total-b.count)):b.isPR()?(b.reviewPRs(f),b.lastPRId=e.LastId,b.totalPRs(e.Total),b.totalPRRemaining(e.Total-b.count)):b.isQA()?(b.reviewQAs(f),b.lastQAId=e.LastId,b.totalQAs(e.Total),b.totalQARemaining(e.Total-b.count)):b.isCheckin()&&(b.checkins(f),b.lastCheckinId=e.LastId,b.totalCheckins(e.Total),b.totalCheckinRemaining(e.Total-b.count)),b.currentUserAvatar(e.CurrentUserAvatar),b.currentUserUrl(e.CurrentUserProfileUrl),b.isLoading(!1)}else b.isLoading(!1)}),c==1&&LoadBreadCrumb()}},b.getYoutubeEmbed=function(a){return'<object width="570" height="375"><param name="movie" value="http://www.youtube.com/v/'+a.YoutubeCode+'?hl=en_US&amp;version=3;hd=1;rel=0;showinfo=0;cc_load_policy=1;showsearch=0;ap=%2526fmt%3D18"/>'+'<param name="allowFullScreen" value="true"></param>'+'<param name="allowscriptaccess" value="always"></param>'+'<embed src="http://www.youtube.com/v/'+a.YoutubeCode+'?hl=en_US&amp;version=3;autoplay=0&amp;loop=0;hd=2;rel=0;showinfo=0;cc_load_policy=1;showsearch=0;ap=%2526fmt%3D18" type="application/x-shockwave-flash" width="550" height="375" allowscriptaccess="always" allowfullscreen="true"></embed>'+"</object>"},CalculatingReviewPostedTime(),b.reviewFilterChange=function(a,c){switch(c.currentTarget.id){case"ddlCriteria":b.criteria(c.currentTarget.value);break;case"ddlLevel":b.level(c.currentTarget.value);break;case"ddlOrderByTime":b.orderByTime(c.currentTarget.value)}b.loadReviews(!1,2)},b.categoryChange=function(a){b.categoryUrlRewriteName($(a).attr("refval")),$("#breadcrumddl>li").removeClass("selected"),$(a).closest("li").addClass("selected"),b.loadReviews(!1)},b.continueLoad=function(){b.loadReviews(!0)},b.continueLoadResReview=function(){b.loadReviews(!0,2)},b.continueLoadUserReview=function(){b.loadReviews(!0,3)},b.addNewReview=function(a){b.reviews.unshift(new GroupItem(a)),b.total(b.total()+1),b.fullTotal(b.fullTotal()+1)},b.replaceReview=function(a){for(var c=0;c<b.reviews().length;c++)if(b.reviews()[c].items[0].Id==a.Id){b.reviews.splice(c,1,new GroupItem(a));break}},b.removeReview=function(a){for(var c=0;c<b.reviews().length;c++)if(b.reviews()[c].items[0].Id==a){b.reviews.splice(c,1);break}b.total(b.total()-1),b.fullTotal(b.fullTotal()-1)},b.checkinGroupDetails=ko.observableArray([]),b.showCheckinDetails=function(a){$("#checkin-group-dialog").modal({persist:!0}),$("#simplemodal-container").css("height","440px"),$("#simplemodal-container").css("width","500px"),$(window).resize();var c=new Date,d=a.items[0].Id,e=a.items[a.items.length-1].Id;b.isLoadingCheckinDetail(!0),$.get("/review/GetResCheckinsByGroup?t="+c.getTime()+"&resId="+b.resId+"&firstId="+d+"&lastId="+e,function(a){a.success&&(b.checkinGroupDetails(a.data),b.isLoadingCheckinDetail(!1))})},b.checkinGroupDetails=ko.observableArray([]),b.isLoadingCheckinDetail=ko.observable(!1),b.afterGenderCheckinGroupItem=function(a,b){var c=$('span.address[id="'+b.Id+'"]');calculatingPostedTime(currentTimeStamp,c)},b.getReviewDetailLink=function(a){return typeof a.ResUrl!="undefined"&&a.ResUrl!=null?"http://www.foody.vn"+a.ResUrl+"/binh-luan-"+a.Id:"http://www.foody.vn"+b.resUrl+"/binh-luan-"+a.Id},b.getTopByRank=function(a){var b=a.PointRank,c=0;return b>0&&b<=10?c=10:b<=50?c=50:b<=100?c=100:b<=500?c=500:b<=1e3&&(c=1e3),"Top "+c},b.commentLikeLoading=ko.observable(!1),b.commentLike=function(a,c){if(!b.commentLikeLoading()){b.commentLikeLoading(!0);var d=!a.IsLiked(),e="/likecomment/like/",f=1;d||(e="/likecomment/unlike/",f=-1);var g={id:a.CommentId,type:c};$.post(e,g,function(c){c.Success?(a.TotalLike(a.TotalLike()+f),a.IsLiked(d),b.commentLikeLoading(!1)):b.commentLikeLoading(!1)})}},b.getCommentLikeText=function(a){return a.IsLiked()?"Unlike":"Like"}};ListReviewsModel.ChangeReviewFilter=function(){var a=window.location.hash,b=0;switch(a){case"#tuyet-voi":b=1;break;case"#kha-tot":b=2;break;case"#trung-binh":b=3;break;case"#kem":b=4}b!=0&&setTimeout(function(){$("#ddlLevel").val(b),resReviewsModel.level(b),resReviewsModel.loadReviews(!1,2)},500)};var GroupItem=function(a){var b=this;b.reviewId=a.Id,b.type=a.ReviewType,b.items=new Array;if(a.Comments!=null)for(var c=0;c<a.Comments.length;c++)RecookComment(a.Comments[c]);a.Comments=ko.observableArray(a.Comments),b.items.push(a),b.isSubmitingComment=ko.observable(!1),b.addComment=function(c,d){var e=d.keyCode,f=0;f=d.shiftKey;if(e==13&&!f){if(!b.isSubmitingComment()){b.isSubmitingComment(!0);var g=b.reviewId,h=GetMediaType(b.type),i=$.trim($(d.target).val());i!=""?$.ajax({type:"POST",url:"/Review/AddComment2",data:{reviewId:g,comment:htmlEncode(i),type:h.toString()},success:function(c){c.success?(updateTotalComment(g,h),$(d.target).val(""),a.Comments.push(RecookComment(c.data)),PointNotify.AddedPointNotify(c.TotalPendingPoints),b.isSubmitingComment(!1)):b.isSubmitingComment(!1)}}):b.isSubmitingComment(!1)}return!1}return!0},b.isLoadingAllComment=ko.observable(!1),b.showAllComments=function(c,d){if(!b.isLoadingAllComment()){b.isLoadingAllComment(!0);var e=new Date;$.get("/review/getallcomments?t="+e.getTime()+"&reviewid="+a.Id+"&type="+GetMediaType(a.ReviewType),function(c){if(c.success){var e=c.data;if(e!=null){a.Comments.removeAll();for(var f=0;f<e.length;f++)a.Comments.push(RecookComment(e[f]))}$(d.target).closest(".view-all-comments").hide(),b.isLoadingAllComment(!1)}else b.isLoadingAllComment(!1)})}}},lastScrollTop=0;$(function(){ListReviewsModel.ChangeReviewFilter(),$(window).bind("hashchange",function(a){ListReviewsModel.ChangeReviewFilter()}),$(window).scroll(function(){var a=$(this).scrollTop();$(window).scrollTop()>$(document).height()-($(window).height()+1e3)&&a>lastScrollTop&&(typeof homeReviewsModel!="undefined"&&homeReviewsModel!=null&&$(".reviews-main-item").length<(numberScrollablePage+1)*homeReviewsModel.count&&homeReviewsModel.loadReviews(!0),typeof resReviewsModel!="undefined"&&resReviewsModel!=null&&$(".review-item").length<(numberScrollablePage+1)*resReviewsModel.count&&resReviewsModel.loadReviews(!0,2),typeof userReviewsModel!="undefined"&&userReviewsModel!=null&&$(".review-item").length<(numberScrollablePage+1)*userReviewsModel.count&&userReviewsModel.loadReviews(!0,3)),lastScrollTop=a}),$(".btn-sum-detail").click(function(){LoginPopup.Show(function(){$.modal.close(),updateRestaurantSummaryCanView(),$(".microsite-box-rating-new").effect("highlight",{},1e3)},function(){})}),autoInsertReviewAds(),setTimeout(function(){addCommentWatermark()})});var insertAdsRate=3
;function populateReviewItem(a,b){if(a!=null){var c=getRatingTooltip(a.Review),d="--";a.Review.AvgRating>0&&(d=a.Review.AvgRating.toFixed(1));var e='<div id="review-'+a.Review.Id+'"><div class="';a.Type==1?e+="micro-home-recent-review ":a.Type==2?e+="user-reviews ":a.Type==3&&(e+="reviews-new-item "),e+='review-item" reviewId="'+a.Review.Id+'" itemprop="review" itemscope itemtype="http://schema.org/Review">'+'<article class="micro-home-review-item">'+'<div class="leftimage">';if(a.Type==1)e+='<div><a href="'+a.Review.UserProfileUrl+'" class="review-user-link" tooltip="#userToolTip_'+a.Review.Id+'"><img witdh="60px" height="60px" src="'+a.Review.CropAvatarUrl+'"/></a></div>'+'<div class="user"><a href="'+a.Review.UserProfileUrl+'" class="review-user-link" tooltip="#userToolTip_'+a.Review.Id+'"><span itemprop="author">'+a.Review.UserFirstName+"</span></a></div>"+'<div class="status" userreviews="userReviews_'+a.Review.UserName+'">'+a.Review.UserReviews+" "+CommonText.review+"</div>"+generateUserTooltip(a.Review),a.CanEdit&&(e+='<a href="javascript:void(0);" class="review-modified" restaurantId="'+a.Review.RestaurantID+'" reviewId="'+a.Review.Id+'" title="'+ReviewText.EditIn1Hour+'"></a>'+'<a href="javascript:void(0);" class="review-deleted" restaurantId="'+a.Review.RestaurantID+'" reviewId="'+a.Review.Id+'" title="'+ReviewText.DeleteIn1Hour+'"></a>');else if(a.Type==2||a.Type==3)e+='<div><a href="'+a.Review.RestaurantMicrositeUrl+'"><img witdh="80px" src="'+a.Review.RestaurantPictureUrl+'"/></a></div>'+'<div class="restaurant-point">',a.Review.RestaurantAvgRating>0?e+='<span itemprop="ratingValue" href="#">'+a.Review.RestaurantAvgRating.toFixed(1)+"</span>":e+='<span itemprop="ratingValue" href="#">--</span>',e+="</div>";e+='</div><div class="rightdesc">';if(a.Type==1)e+='<div><div class="title"><a itemprop="description" href="'+a.Review.RestaurantMicrositeUrl+"/binh-luan-"+a.Review.Id+'">'+a.Review.Title+"</a></div>",a.Review.ReviewType==1?e+='<div class="review-point" itemprop="reviewRating" itemscope itemtype="http://schema.org/Rating"><a itemprop="ratingValue" onclick="return false;" href="javascript:void(0);" reviewid="'+a.Review.Id+'" tooltip="ratingTooltip_'+a.Review.Id+'" >'+d+"</a>"+"</div>":a.Review.ReviewType==2?e+='<div class="review-pr" title="Quảng cáo"></div>':a.Review.ReviewType==3&&(e+='<div class="review-qa" title="Hỏi đáp"></div>'),e+='</div><div class="timerow"><span class="address" itemprop="datePublished" data-utime="'+a.PostedTimestamp+'" title="'+formatJSONDate(a.Review.CreatedOn)+'"></span>',a.Review.PostedByDeviceName!=null&&a.Review.PostedByDeviceName!=""&&(e+=' <a class="viamobile" href="/ung-dung-mobile">via '+a.Review.PostedByDeviceName,e+='<img src="'+staticPath+'Style/images/icons/icon-via-mobile.png" class="iphone" /></a>'),e+="<div>";else if(a.Type==2||a.Type==3)e+='<div class="reviews-headers"><h1 class="restitle"><a href="'+a.Review.RestaurantMicrositeUrl+'">'+a.Review.RestaurantName+"</a> ("+a.Review.RestaurantTotalReviews+" bình luận)</h1>"+'<div class="resaddress">'+a.Review.RestaurantAddress+", "+a.Review.RestaurantDistrictName+", "+a.Review.RestaurantProvinceName+"</div>"+'<h2 class="title"><a itemprop="description" href="'+a.Review.RestaurantMicrositeUrl+"/binh-luan-"+a.Review.Id+'">'+a.Review.Title+"</a></h2>"+'<div class="user" itemprop="author">',a.Type==3&&(e+='<a href="'+a.Review.UserProfileUrl+'" class="review-user-link" tooltip="#userToolTip_'+a.Review.Id+'"> <img src="'+a.Review.CropAvatarUrl+'" style="width:30px; height:30px; float:left; vertical-align:middle; margin-right:5px;"/><span>'+a.Review.UserFirstName+"</span></a> ("+a.Review.UserReviews+" bình luận) | "),e+='<span class="address" style="float:none; border:none" itemprop="datePublished" data-utime="'+a.PostedTimestamp+'" title="'+formatJSONDate(a.Review.CreatedOn)+'"></span>',a.Review.PostedByDeviceName!=null&&a.Review.PostedByDeviceName!=""&&(e+=' <a class="viamobile" href="/ung-dung-mobile">via '+a.Review.PostedByDeviceName,e+='<img src="'+staticPath+'Style/images/icons/icon-via-mobile.png" class="iphone" /></a>'),e+="</div>",e+=generateUserTooltip(a.Review),a.Review.ReviewType==1?e+='<div class="review-point" itemprop="reviewRating" itemscope itemtype="http://schema.org/Rating"><meta content="10" itemprop="bestRating"><a itemprop="ratingValue" href="javascript:void(0);" onclick="return false;" reviewid="'+a.Review.Id+'" tooltip="ratingTooltip_'+a.Review.Id+'" >'+d+"</a>"+"</div>":a.Review.ReviewType==2?e+='<div class="review-pr" title="Quảng cáo"></div>':a.Review.ReviewType==3&&(e+='<div class="review-qa"  title="Hỏi đáp"></div>'),e+="</div>";e+='<div class="desc" itemprop="reviewBody" style="white-space: pre-line;">'+a.Review.Comment+"</div>"+generateReviewOptions(a.Review)+addYoutube(a.Review.YoutubeCode)+'<div id="review-pictures'+a.Review.Id+'"></div>'+generateReviewShare(a.Review)+generateReviewComments(a.CommentsList,a.IsLogin)+"</div>"+"</article>"+"</div>"+"</div>",b==null&&(b="#review-list"),$(b).append(e),a.Review.AvgRating>0&&generateRatingTooltipContent(a.Review),bindAutoResize(a.Review.Id),bindCommentWatermark(a.Review.Id),bindUserTooltipAjaxLoading(a.Review.Id),bindPostedTime(a.Review.Id),bindCommentPostedTime(a.Review.Id),bindEditOrDeleteReviewTooltip(),bindPRQATooltip(),bindReviewReportByReviewId(a.Review.Id),a.Review.TotalPictures>0&&$.get(GetLoadReviewPictureLink(a.Review.Id),function(b){$("#review-pictures"+a.Review.Id).html(b),$(".review-img-"+a.Review.Id).foodybox()})}}function populateHomeReviewItem(a){if(a!=null){var b=getRatingTooltip(a.Review),c="--";a.Review.AvgRating>0&&(c=a.Review.AvgRating.toFixed(1));var d='<div id="review-'+a.Review.Id+'"><div class="';d+='reviews-main-item" reviewId="'+a.Review.Id+'">'+"<article>"+'<div class="rightimage">',d+='<div><a href="'+a.Review.RestaurantMicrositeUrl+'"><img width="140px" src="'+a.Review.RestaurantPictureUrl+'"/></a></div>',d+='<div class="review-home-pop-link"><span><a href="javascript:void(0)" class="restaurant-reviews-link" resid="'+a.Review.RestaurantID+'">'+a.Review.RestaurantTotalReviews+" "+Text.reviews+"</a></span> | "+'<span><a href="'+a.Review.RestaurantMicrositeUrl+'/album-anh">'+a.Review.TotalRestaurantPictures+" "+Text.photos+"</a> </span>"+"</div>",d+='</div><div class="leftcontent">',d+='<div class="reviews-headers"><h1 class="restitle"><a href="'+a.Review.RestaurantMicrositeUrl+'">'+a.Review.RestaurantName+"</a>",a.Review.TotalRestaurantRecentReviews>0&&(d+='<span> (<a href="'+a.Review.RestaurantMicrositeUrl+'" style="font-size:12px; font-weight:normal;color:#02AAD4;text-transform:none;">'+a.Review.TotalRestaurantRecentReviews+" "+ReviewText.ReviewsInDay+"</a>)</span>"),d+='</h1><div class="resaddress">'+a.Review.RestaurantAddress+", "+a.Review.RestaurantDistrictName+", "+a.Review.RestaurantProvinceName+"</div>"+'<div class="reviews-main-inside"><h2 class="title" itemprop="name"><a href="'+a.Review.RestaurantMicrositeUrl+"/binh-luan-"+a.Review.Id+'">'+a.Review.Title+"</a></h2>",a.CanEdit&&(d+='<a href="javascript:void(0);" class="review-modified" restaurantId="'+a.Review.RestaurantID+'" reviewId="'+a.Review.Id+'" title="'+ReviewText.EditIn1Hour+'"></a>'+'<a href="javascript:void(0);" class="review-deleted" restaurantId="'+a.Review.RestaurantID+'" reviewId="'+a.Review.Id+'" title="'+ReviewText.DeleteIn1Hour+'"></a>'),d+='<div class="user" itemprop="author">',d+='<a href="'+a.Review.UserProfileUrl+'" class="user-link" refId="'+a.Review.UserID+'" tooltip="userToolTip_'+a.Review.UserID+'"> <img src="'+a.Review.CropAvatarUrl+'" style="width:30px; height:30px; float:left; vertical-align:middle; margin-right:5px;"/><span>'+a.Review.UserFirstName+"</span>",d+='</a> - <span class="address" style="float:none; border:none" itemprop="datePublished" data-utime="'+a.PostedTimestamp+'" title="'+formatJSONDate(a.Review.CreatedOn)+'"></span>',a.Review.PostedByDeviceName!=null&&a.Review.PostedByDeviceName!=""&&(d+=' <a class="viamobile" href="/ung-dung-mobile">via '+a.Review.PostedByDeviceName,d+='<img src="'+staticPath+'Style/images/icons/icon-via-mobile.png" class="iphone" /></a>'),a.Review.TotalUserRecentReviews>0&&(d+=' | <span><a href="'+a.Review.UserProfileUrl+'" style="color:#02AAD4; font-size:11px; font-weight:normal;text-transform:none;"><c>'+a.Review.TotalUserRecentReviews+"</c> "+ReviewText.ReviewsInDay+"</a></span>"),d+="</div>",a.Review.ReviewType==1?d+='<div class="review-point"><a itemprop="ratingValue" href="javascript:void(0);" onclick="return false;" reviewid="'+a.Review.Id+'" tooltip="ratingTooltip_'+a.Review.Id+'" >'+c+"</a>"+"</div>":a.Review.ReviewType==2?d+='<div class="review-pr" title="Quảng cáo"></div>':a.Review.ReviewType==3&&(d+='<div class="review-qa" title="Hỏi đáp"></div>'),d+='<div class="desc" itemprop="description" style="white-space: pre-line;">'+a.Review.Comment+"</div>"+generateReviewOptions(a.Review)+addYoutubeHome(a.Review.YoutubeCode)+'<div id="review-pictures'+a.Review.Id+'"></div></div></div>'+generateReviewShare(a.Review)+generateReviewComments(a.CommentsList,a.IsLogin)+"</div>"+"</article>"+"</div>"+"</div>",$("#review-list").append(d),a.Review.AvgRating>0&&generateRatingTooltipContent(a.Review),bindAutoResize(a.Review.Id),bindCommentWatermark(a.Review.Id),bindUserTooltipAjaxLoading(a.Review.Id),bindPostedTime(a.Review.Id),bindCommentPostedTime(a.Review.Id),bindEditOrDeleteReviewTooltip(),bindPRQATooltip(),bindReviewReportByReviewId(a.Review.Id),a.Review.TotalPictures>0&&$.get(GetLoadReviewPictureLink(a.Review.Id),function(b){$("#review-pictures"+a.Review.Id).html(b),$(".review-img-"+a.Review.Id).foodybox()})}}function addYoutubeHome(a){var b="";return a!=null&&(b+="<div>",b+='<object width="500" height="375">',b+='<param name="movie" value="http://www.youtube.com/v/'+a+'?hl=en_US&amp;version=3;hd=1;rel=0;showinfo=0;cc_load_policy=1;showsearch=0;ap=%2526fmt%3D18"></param>',b+='<param name="allowFullScreen" value="true"></param>',b+='<param name="allowscriptaccess" value="always"></param>',b+='<embed src="http://www.youtube.com/v/'+a+'?hl=en_US&amp;version=3;autoplay=0&amp;loop=0;hd=2;rel=0;showinfo=0;cc_load_policy=1;showsearch=0;ap=%2526fmt%3D18" type="application/x-shockwave-flash" width="500" height="375" allowscriptaccess="always" allowfullscreen="true"></embed>',b+="</object>",b+="</div>"),b}function addYoutube(a){var b="";return a!=null&&$.trim(a)!=""&&(b+='<div style="float:left; width:500px;margin-top:5px;">',b+='<object width="500" height="375">',b+='<param name="movie" value="http://www.youtube.com/v/'+a+'?hl=en_US&amp;version=3;hd=1;rel=0;showinfo=0;cc_load_policy=1;showsearch=0;ap=%2526fmt%3D18"></param>',b+='<param name="allowFullScreen" value="true"></param>',b+='<param name="allowscriptaccess" value="always"></param>',b+='<embed src="http://www.youtube.com/v/'+a+'?hl=en_US&amp;version=3;autoplay=0&amp;loop=0;hd=2;rel=0;showinfo=0;cc_load_policy=1;showsearch=0;ap=%2526fmt%3D18" type="application/x-shockwave-flash" width="500" height="375" allowscriptaccess="always" allowfullscreen="true"></embed>',b+="</object>",b+="</div>"),b}function bindAutoResize(a){$("#write_comment_"+a).autoresize({minRows:0,buffer:0,animate:!1})}function bindCommentWatermark(a){$("#write_comment_"+a).watermark(ReviewText.CommentWatermark,{className:"comment-watermark",useNative:!1})}function generateReviewOptions(a){var b="";a.SelectMenu!=null&&a.SelectMenu!=""&&(b+='<div class="optionals">Đã thưởng thức: <span>'+a.SelectMenu+"</span></div>");var c="";a.Guest!=null&&a.Guest!=""&&(c=ReviewText.People+": <span>"+a.Guest+"</span>");var d="";a.MoneySpend!=null&&a.MoneySpend!=""&&(d=ReviewText.Cost+": <span>"+a.MoneySpend+"</span>");var e="";a.VisitAgain!=null&&a.VisitAgain!=""&&(e=ReviewText.Comeback+": <span>"+a.VisitAgain+"</span>");if(c!=""||d!=""||e!=""){var f=!1;b+='<div class="optionals">',c!=""&&(b+=c,f=!0),d!=""&&(f?b+=" | "+d:b+=d,f=!0),e!=""&&(f?b+=" | "+e:b+=e),b+="</div>"}return b}function returnZeroAsNull(a){return a==null?0:a}function getRatingTooltip(a){var b='<div class="top-arrow"><img src="'+staticPath+'Style/images/icons/arrow-top.png" alt=""/></div>'+"<div>"+'<h2 style="padding-bottom:5px; border-bottom:#ddd 1px dashed; margin-bottom:5px; font-weight:bold;">'+ReviewText.PointRating+"</h2>"+'<table class="point-popup">'+"<tr>"+'<td width="90">'+ReviewText.Position+"</td>"+"<td>"+'<div id="positionPointBar_'+a.Id+'" class="reviewPointBar">'+"</div>"+"</td>"+'<td width="20" align="right">'+"<b>"+returnZeroAsNull(a.Position)+"</b>"+"</td>"+"</tr>"+"<tr>"+"<td>"+ReviewText.Price+"</td>"+"<td>"+'<div id="pricePointBar_'+a.Id+'" class="reviewPointBar">'+"</div>"+"</td>"+'<td width="20" align="right">'+"<b>"+returnZeroAsNull(a.Price)+"</b>"+"</td>"+"</tr>"+"<tr>"+"<td>"+ReviewText.Food+"</td>"+"<td >"+'<div id="foodPointBar_'+a.Id+'" class="reviewPointBar">'+"</div>"+"</td>"+'<td width="20" align="right">'+"<b>"+returnZeroAsNull(a.Food)+"</b>"+"</td>"+"</tr>"+"<tr>"+"<td>"+ReviewText.Service+"</td>"+"<td>"+'<div id="servicePointBar_'+a.Id+'" class="reviewPointBar">'+"</div>"+"</td>"+'<td width="20" align="right">'+"<b>"+returnZeroAsNull(a.Services)+"</b>"+"</td>"+"</tr>"+"<tr>"+"<td>"+ReviewText.Atmosphere+"</td>"+"<td>"+'<div id="atmospherePointBar_'+a.Id+'" class="reviewPointBar">'+"</div>"+"</td>"+'<td width="20" align="right">'+"<b>"+returnZeroAsNull(a.Atmosphere)+"</b>"+"</td>"+"</tr>"+"</table>";return b}function generateRatingTooltipContent(a){var b=parseInt(a.Position)*10,c=parseInt(a.Price)*10,d=parseInt(a.Food)*10,e=parseInt(a.Services)*10,f=parseInt(a.Atmosphere)*10;$("#positionPointBar_"+a.Id).progressbar({value:b}),$("#pricePointBar_"+a.Id).progressbar({value:c}),$("#foodPointBar_"+a.Id).progressbar({value:d}),$("#servicePointBar_"+a.Id).progressbar({value:e}),$("#atmospherePointBar_"+a.Id).progressbar({value:f}),bindReviewRatingTooltipAjaxLoading(a.Id)}function generateReviewPictures(a){var b="";if(a.ReviewPictures!=null&&a.ReviewPictures.length>0){b='<div class="photos thumb review-photo">';for(var c=0;c<a.ReviewPictures.length;c++)b+='<a href="'+a.ReviewPictures[c].FullImagePath+'" class="review-img review-img-'+a.ReviewPictures[c].ReviewID+'" title="'+a.ReviewPictures[c].PictureName+'" data-id="'+a.ReviewPictures[c].RestaurantPictureID+'" data-group="1" data-size="'+a.ReviewPictures[c].Size+'" ><img alt="" src="'+a.ReviewPictures[c].FileName+'" /></a>';b+="</div>"}return b}function generateReviewShare(a){var b=encodeURIComponent("http://"+document.domain+"/"+a.RestaurantMicrositeUrl+"/binh-luan-"+a.Id),c=encodeURIComponent(a.Title+" - "+a.RestaurantName),d="";return a!=null&&(d+='<div class="share"><div class="share-left"><a href="javascript:void(0);" onclick="showCommentTextBox('+a.Id+'); return false;" ><span class="icocomment"></span><span>'+Text.Comment+'</span></a>  <a href="javascript:void(0);" reviewId="'+a.Id+'"  class="review-helpful-link" tooltip="#helpfulTooltip_'+a.Id+'" onclick="addThanks(this); return false;"><span class="icolike"></span> <span>'+ReviewText.Helpful+' (<span style="float:none;" id="totalThanks_id_'+a.Id+'">'+a.TotalReviewFavourites+"</span>)<span></a>"+'  <a class="review-report-error" reviewid="'+a.Id+'"><span class="icoreport"></span> '+ReviewText.ReportError+"</a>"+'<div id="helpfulTooltip_'+a.Id+'" class="helpfultooltip"></div>'+"</div>"+'<div class="share-right">',d+='<a href="javascript:void(0);" shareUrl="'+b+'" onclick="postToFacebookFeed(this);" reviewId="'+a.Id+'" shareName="'+c+'"><img style="display: inline; width: 16px; height: 16px" src="'+staticPath+'Scripts/social-sharing/facebook_share.png" alt="Share on Facebook" /></a>',d+=' <a href="javascript:void(0);" shareUrl="'+b+'" onclick="postToGoogleFeed(this);" reviewId="'+a.Id+'" shareName="'+c+'"><img style="display: inline;" src="'+staticPath+'Scripts/social-sharing/gplus-16.png" alt="Share on Google+" /></a>',d+=' <a href="javascript:void(0);" shareUrl="'+b+'" onclick="postToLinkedInFeed(this);" reviewId="'+a.Id+'" shareName="'+c+'"><img style="display: inline; width: 16px; height: 16px;" src="'+staticPath+'Scripts/social-sharing/linkedin.png" alt="Share on LinkedIn" /></a>',d+=' <a href="javascript:void(0);" shareUrl="'+b+'" onclick="postToTwitterFeed(this);" reviewId="'+a.Id+'" shareName="'+c+'"><img style="display: inline;" src="'+staticPath+'Scripts/social-sharing/bird_blue_16.png" alt="Share on Twitter" /></a>',d+="</div>",d+="</div>"),d}function generateReviewComments(a,b){var c="";if(a!=null){c+='<div class="review-reply" style="margin-left:0px"><div id="commentBox_'+a.ReviewID+'">',a.ShowViewAllLink&&(c+='<div class="view-all-comments"><a href="javascript:void(0);" id="view_all_comment_{0}'+a.ReviewID+'" onclick="showAllComments('+a.ReviewID+'); return false;">Hiện tất cả (<span id="comment_count_'+a.ReviewID+'">'+a.TotalComments+"</span>)</a>"+"</div>");if(a.CommentsList!=null&&a.CommentsList.length>0)for(var d=0;d<a.CommentsList.length;d++)c+=generateCommentItem(a.CommentsList[d]);c+='</div><div class="review-reply-item addcomment" id="review_comment_id_'+a.ReviewID+'"',b?a.CommentsList.length==0&&(c+='style="display:none"'):c+='style="display:none"',c+='><div class="review-reply-item-avatar"><a href="'+a.CurrentUserProfileUrl+'">'+'<img src="'+a.Avatar+'" width="30" /></a></div>'+'<div class="review-reply-item-content">'+'<textarea type="text" spellcheck="false" title="'+ReviewText.CommentWatermark+' " class="write_comment" id="write_comment_'+a.ReviewID+'" reviewId='+a.ReviewID+' onkeypress="addComment(this,event)"></textarea>'+"</div>"+"</div>"+"</div>"}return c}function generateCommentItem(a){var b="";return a!=null&&(b+='<div class="review-reply-item"><div class="review-reply-item-avatar"><a href="'+a.UserProfileUrl+'">'+'<img src="'+a.CropAvatarUrl+'" width="30" /></a></div>'+'<div class="review-reply-item-content">',a.CanDelete&&(b+='<span><a href="javascript:void(0);" commentId="'+a.CommentID+'" class="btn-close-small remove-review-comment"> x </a></span>'),b+='<a href="'+a.UserProfileUrl+'" class="user-link" refId="'+a.UserID+'" tooltip="userCommentToolTip_'+a.UserID+'" itemprop="author">'+a.UserFirstName+'</a> <span itemprop="description" style="white-space: pre-line;">'+a.Comment+"</span>"+"<br />"+'<span class="address" style="float:none; border:none;font-size:11px;" itemprop="datePublished" data-utime="'+a.PostedTimeStamp+'" title="'+formatJSONDate(a.CreatedOn)+'"></span>'+"</div>"+"</div>"),b}function generateUserCommentTooltip(a){var b="";return a!=null&&(b+='<div id="userCommentToolTip_'+a.CommentID+'" style="display:none;" class="tooltip">'+'<div class="left-arrow"><img src="'+staticPath+'Style/images/icons/arrow-left.png" alt=""/></div>'+'<div class="tooltip-left">'+'<div><img width="100px" src="'+a.AvatarUrl+'" alt=""/></div>'+"</div>"+'<div class="tooltip-right">'+'<div class="tooltip-fullname"><b>'+a.UserFullName+"</b></div>"+"<div><span>"+a.UserReviews+"</span> "+CommonText.review+"</div>"+"<div><span>"+a.UserPictures+"</span> "+CommonText.uploadphoto+"</div>"+'<div style="display:none"><span>213</span> '+CommonText.thanks+"</div>"+"</div>"+"</div>"),b}function generateUserTooltip(a){var b="";return a!=null&&(b+='<div id="userToolTip_'+a.Id+'" style="display:none;" class="tooltip">'+'<div class="left-arrow"><img src="'+staticPath+'Style/images/icons/arrow-left.png" alt=""/></div>'+'<div class="tooltip-left">'+'<div><img width="100px" src="'+a.AvatarUrl+'" alt=""/></div>'+"</div>"+'<div class="tooltip-right">'+'<div class="tooltip-fullname"><b>'+a.FullName+"</b></div>"+"<div><span>"+a.UserReviews+"</span> "+CommonText.review+"</div>"+"<div><span>"+a.UserPictures+"</span> "+CommonText.uploadphoto+"</div>"+'<div style="display:none"><span>213</span> '+CommonText.thanks+"</div>"+"</div>"+"</div>"),b}function bindUserTooltipAjaxLoading(a){$(".user-link").each(function(){addUserTooltip(this)}),$('div.review-item[reviewId="'+a+'"] .review-reply-item .comment-user-link').each(function(){addUserTooltip(this)}),$('div.reviews-main-item[reviewId="'+a+'"] .review-reply-item .comment-user-link').each(function(){addUserTooltip(this)}),$('.review-helpful-link[tooltip="#helpfulTooltip_'+a+'"]').each(function(){addHelpfulTooltip(this)})}function bindUserCommentTooltipAjaxLoading(a){a!=null&&$('.comment-user-link[tooltip="#userCommentToolTip_'+a.CommentID+'"]').each(function(){addUserTooltip(this)})}function formatJSONDate(a){var b=new Date(parseInt(a.slice(6,-2))),c=b.getDate();c<10&&(c="0"+c);var d=1+b.getMonth();return d<10&&(d="0"+d),c+"/"+d+"/"+b.getFullYear()}typeof staticPath=="undefined"&&(staticPath="")
;function saveDraftReview(a){var b="";$("#txtReviewContent").mentionsInput("getMentions",function(a){var c=[];for(var d=0;d<a.length;d++)c.push({Id:a[d].id,Name:a[d].value});b=JSON.stringify(c)});var c=$("#txtReviewContent").data("messageText");if(!c||c.length==0)c=$("#txtReviewContent").val();var d={Title:$("#txtReviewTitle").val(),ReviewContent:c,PositionPoint:clickedOnRating?$("#hdpositionPoint").val():null,PricePoint:clickedOnRating?$("#hdpricePoint").val():null,FoodPoint:clickedOnRating?$("#hdfoodPoint").val():null,ServicePoint:clickedOnRating?$("#hdservicePoint").val():null,AtmospherePoint:clickedOnRating?$("#hdatmospherePoint").val():null,DishesChosen:$("#hdDishesChosen").val(),Guest:$("#hdGuest").val(),MoneySpend:$("#hdMoneySpend").val(),VisitAgain:$("#hdVisitAgain").val(),RestaurantId:$("#hdRestaurantId").val(),RestaurantName:$("#hdRestaurantName").val(),YoutubeCode:$("#YoutubeCode").val(),hashtagsString:b,IsPrivateFeedback:$("#hdprivateFeedback").val()};$("#review-auto-save").css("display","block"),$.post("/Review/SaveReviewAsDraft",d,function(b){if(b.Success){$("#review-auto-save").css("display","none");if(currentReviewID=="undefined"||currentReviewID==null||currentReviewID==0)currentReviewID=b.ReviewId,UploadReview.AutoSavePictureChange();currentReviewID=b.ReviewId,typeof a!="undefined"&&a!=null&&a()}})}function clickedForRating(){return clickedOnRating?($("#ratingError").text(""),$("#review-not-rating-div").hide()):($("#ratingError").text(ReviewText.RequiredPointMsg),$("#review-not-rating-div").show()),clickedOnRating}function doneTyping(){saveDraftReview()}function donePictureAction(){UploadReview.SavePictureAsDraft(currentReviewID,tokenUploadKey)}function bindSlider(a,b,c){var d=$(c).val();d==null||d==""?d=6:clickedOnRating=!0,$(a).slider({range:"min",value:d,min:1,max:10,slide:function(a,d){$(b).text(d.value),$(c).val(d.value)},change:function(a,b){clickedOnRating=!0,$("#ratingError").css("display","none"),$("#review-not-rating-div").hide();var c=getAveragePoints();$("#ratingAverage").text("("+c+")"),$("#ratingAverageText").text(getPointsAppropriateText(c));var d=getPointsAppropriateColor(c);$("#ratingAverage").css("color",d),$("#ratingAverageText").css("color",d),UploadReview.AutoSaveSliderChange()}}),$(b).text($(a).slider("value")),$(c).val($(a).slider("value"))}function ddlOptionChange(a,b){var c=$(a).val();$(b).val(c)}function getAveragePoints(){var a=0,b=parseInt($("#hdpositionPoint").val()),c=parseInt($("#hdpricePoint").val()),d=parseInt($("#hdfoodPoint").val()),e=parseInt($("#hdservicePoint").val()),f=parseInt($("#hdatmospherePoint").val());return a=(b+c+d+e+f)/5,parseFloat(a).toFixed(1)}function getPointsAppropriateText(a){var b="";return a<5?b=CommonText.MicrositeRatingBad:a<7?b=CommonText.MicrositeRatingAverage:a<9?b=CommonText.MicrositeRatingGood:b=CommonText.MicrositeRatingExcellent,b}function getPointsAppropriateColor(a){var b="";return a<5?b="#cc0000":a<7?b="#000":b="#03ae03",b}function validInput(){var a=!0;$.trim($("#txtReviewTitle").val())==""&&$.watermark.show("#txtReviewTitle");var b=!0;return $.trim($("#txtReviewContent").val())==""?(b=!1,$.watermark.show("#txtReviewContent"),$("#error-ReviewContent").css("display","inline")):b=!0,clickedForRating()&&a&&b}function showLoadingProcess(){$("#addNewReviewLoadingImg").css("display","block")}function hideLoadingProcess(){$("#addNewReviewLoadingImg").css("display","none")}function word_count(a){var b=0,c=$(a).val().match(/\b/g);c&&(b=c.length/2);if(b>0){var d=reviewLength/totalSteps,e=100/totalSteps,f=b%d;if(f>0){var g=(b-f)/d;if(g<=totalSteps){var h=e*g;$(".typeometer-bar").css("width",h+"%"),$(".typeometer-right").text(b-f+"+")}else $(".typeometer-bar").css("width","100%"),$(".typeometer-right").text(reviewLength+"+")}}else $(".typeometer-bar").css("width","0%"),$(".typeometer-right").text("")}function killAutoSave(){typeof typingTimer!="undefined"&&clearTimeout(typingTimer),typeof photoActionTimer!="undefined"&&clearTimeout(photoActionTimer)}function youtube_parser(a){var b=/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/,c=/([^#\&\?]*){11}/,d=a.match(b),e=a.match(c);return d!=null&&d&&d[7].length==11?d[7]:e!=null&&e[0].length==11?a:!1}var clickedOnRating=!1,isModifiedMode=!1,reviewLength=300,totalSteps=20,UploadReview=function(){};UploadReview.Init=function(a){BindingSuggestReviewTitle(),bindSlider("#positionPointSlider","#positionPoint","#hdpositionPoint"),bindSlider("#pricePointSlider","#pricePoint","#hdpricePoint"),bindSlider("#foodPointSlider","#foodPoint","#hdfoodPoint"),bindSlider("#servicePointSlider","#servicePoint","#hdservicePoint"),bindSlider("#atmospherePointSlider","#atmospherePoint","#hdatmospherePoint"),$("#ddlGuest").change(function(){ddlOptionChange(this,"#hdGuest")}),$("#ddlMoneySpend").change(function(){ddlOptionChange(this,"#hdMoneySpend")}),$("#ddlVisitAgain").change(function(){ddlOptionChange(this,"#hdVisitAgain")}),$("#txtReviewTitle").watermark(ReviewText.TitleWatermark,{className:"reviewform-errorText",useNative:!1}),$("#txtReviewContent").watermark(ReviewText.ContentWatermark,{className:"reviewform-errorText",useNative:!1}),$("#YoutubeCode").watermark("Chèn code link video từ Youtube, ví dụ: d1G23B8giN0",{className:"reviewform-errorText",useNative:!1}),$("#txtReviewContent").blur(function(){$.trim($(this).val())==""?$("#error-ReviewContent").css("display","inline"):$("#error-ReviewContent").css("display","none")}),$("#ddlGuest").val($("#hdGuest").val()),$("#ddlMoneySpend").val($("#hdMoneySpend").val()),$("#ddlVisitAgain").val($("#hdVisitAgain").val()),word_count("#txtReviewContent"),$("#txtReviewContent").keyup(function(){word_count("#txtReviewContent")}),a?(UploadReview.AutoSaveTextboxChange("#txtReviewContent"),UploadReview.AutoSaveTextboxChange("#txtReviewTitle"),UploadReview.AutoSaveOptionChange("#ddlGuest"),UploadReview.AutoSaveOptionChange("#ddlMoneySpend"),UploadReview.AutoSaveOptionChange("#ddlVisitAgain"),UploadReview.AutoSaveOptionChange("#YoutubeCode"),UploadReview.AutoSaveOptionChange("#hdprivateFeedback"),UploadReview.IsAutoSave=!0):UploadReview.IsAutoSave=!1,$("#YoutubeCode").change(function(){var a=youtube_parser($("#YoutubeCode").val());a!=0&&a!=""?$("#YoutubeCode").val(a):$("#YoutubeCode").val("")})};var bindedErrorWaterMark=!1,tokenUploadKey=null;UploadReview.SavePictureAsDraft=function(a,b){a==null||a==0?saveDraftReview(function(){a!=null&&a!=0&&b!=null&&b!=""&&($("#review-auto-save").show(),$.post("/Upload/SavePicturesAsDraft",{reviewId:a,tokenKey:b},function(a){$("#review-auto-save").hide()}))}):a!=null&&a!=0&&b!=null&&b!=""&&($("#review-auto-save").show(),$.post("/Upload/SavePicturesAsDraft",{reviewId:a,tokenKey:b},function(a){$("#review-auto-save").hide()}))};var typingTimer,photoActionTimer,doneTypingInterval=2e3,donePhotoActionInterval=1e3;UploadReview.AutoSaveTextboxChange=function(a){$(a).change(function(){clearTimeout(typingTimer),a&&(typingTimer=setTimeout(doneTyping,doneTypingInterval))}),$(a).keyup(function(){clearTimeout(typingTimer),a&&(typingTimer=setTimeout(doneTyping,doneTypingInterval))})},UploadReview.IsAutoSave=!1,UploadReview.AutoSaveSliderChange=function(){UploadReview.IsAutoSave&&(clearTimeout(typingTimer),typingTimer=setTimeout(doneTyping,doneTypingInterval))},UploadReview.AutoSaveOptionChange=function(a){$(a).change(function(){clearTimeout(typingTimer),typingTimer=setTimeout(doneTyping,doneTypingInterval)})},UploadReview.AutoSavePictureChange=function(){UploadReview.IsAutoSave&&(clearTimeout(photoActionTimer),photoActionTimer=setTimeout(donePictureAction,donePhotoActionInterval))},UploadReview.ShowLoadingDialog=function(){$("#loadingDialog").length==0&&$("body").append('<div id="loadingDialog" style="display:none;"><div style="padding-top:100px; padding-bottom:100px;padding-left:400px;"><img alt="Đang tải ..." src="'+staticPath+'Style/images/loading-review.gif" /></div></div>'),$.modal.close(),$("#loadingDialog").modal()},UploadReview.LoadAddNewReviewForm=function(a,b,c){var d=new Date;UploadReview.ShowLoadingDialog(),clickedOnRating=!1,$.ajax({type:"GET",url:"/Common/IsLogin?"+d.getTime(),success:function(d){d.success==1?UploadReview.OpenWriteReviewForm(a,b,c):LoginPopup.Show(function(){$.modal.close(),UploadReview.OpenWriteReviewForm(a,b,c)},c)}})},UploadReview.LoadModifiedReviewForm=function(a,b,c,d){var e=new Date;$.get("/review/CanEditOrUpdateReview?reviewid="+a+"&t="+e.getTime(),function(e){if(e.Success)UploadReview.ShowLoadingDialog(),UploadReview.OpenEditReviewForm(a,b,c,d);else switch(e.ErrorType){case 3:LoginPopup.Show(function(){$.modal.close(),UploadReview.OpenEditReviewForm(a,b,c,d)});break;case 1:alert(ReviewText.CannotEditIfNotOwner);break;case 2:alert(ReviewText.EditTimeIsOver);break;case 4:alert(ReviewText.CannotEditIfApproved)}}),UploadReview.CurrentRestaurantId=b,UploadReview.UploadReviewSuccessCallback=c},UploadReview.UploadReviewSuccessCallback=null,UploadReview.CurrentRestaurantId=0,UploadReview.OpenWriteReviewForm=function(a,b,c){$.modal.close();var d=new Date,e="/Review/OpenNewReviewForm?restaurantId="+a+"&t="+d.getTime();$("#reviewDialog").length==0&&$("body").append('<div id="reviewDialog" style="display: none"></div>'),$("#reviewDialog").html('<div style="padding-top:100px; padding-bottom:100px;padding-left:400px;"><img alt="Đang tải ..." src="'+staticPath+'Style/images/loading-review.gif" /></div>').modal({onClose:function(a){inUploadProcessing?confirm("Ảnh đang được tải lên, bạn có muốn dừng ngay!")&&(inUploadProcessing=!1,killAutoSave(),$.modal.close(),typeof c!="undefined"&&c!=null&&c()):(killAutoSave(),$.modal.close(),typeof c!="undefined"&&c!=null&&c())}}),$("#reviewDialog").load(e,function(){setupReviewUpload()}).modal({onClose:function(a){inUploadProcessing?confirm("Ảnh đang được tải lên, bạn có muốn dừng ngay!")&&(inUploadProcessing=!1,killAutoSave(),$.modal.close(),typeof c!="undefined"&&c!=null&&c()):(killAutoSave(),$.modal.close(),typeof c!="undefined"&&c!=null&&c())}}),UploadReview.CurrentRestaurantId=a,UploadReview.UploadReviewSuccessCallback=b},UploadReview.OpenEditReviewForm=function(a,b,c,d){isModifiedMode=!0,$.modal.close();var e=new Date,f="/Review/OpenNewReviewForm?restaurantId="+b+"&modifiedReviewId="+a+"&t="+e.getTime();$("#reviewDialog").length==0&&$("body").append('<div id="reviewDialog" style="display: none"></div>'),$("#reviewDialog").html('<div style="padding-top:100px; padding-bottom:100px;padding-left:400px;"><img alt="Đang tải ..." src="'+staticPath+'Style/images/loading-review.gif" /></div>').modal({onClose:function(a){inUploadProcessing||(killAutoSave(),$.modal.close(),typeof d!="undefined"&&d!=null&&d())}}),$("#reviewDialog").load(f,function(){setupReviewUpload()}).modal({onClose:function(a){inUploadProcessing||(killAutoSave(),typeof d!="undefined"&&d!=null&&d(),$.modal.close())}}),UploadReview.CurrentRestaurantId=b,UploadReview.UploadReviewSuccessCallback=c},UploadReview.PostReview=function(a){if(validInput())if(!inUploadProcessing){killAutoSave(),showLoadingProcess();var b="";$("#txtReviewContent").mentionsInput("getMentions",function(a){var c=[];for(var d=0;d<a.length;d++)c.push({Id:a[d].id,Name:a[d].value});b=JSON.stringify(c)});var c=$("#txtReviewContent").data("messageText");if(!c||c.length==0)c=$("#txtReviewContent").val();var d={ReviewId:$("#ReviewId").val(),IsModified:$("#IsModified").val(),Title:$("#txtReviewTitle").val(),ReviewContent:c,PositionPoint:clickedOnRating?$("#hdpositionPoint").val():null,PricePoint:clickedOnRating?$("#hdpricePoint").val():null,FoodPoint:clickedOnRating?$("#hdfoodPoint").val():null,ServicePoint:clickedOnRating?$("#hdservicePoint").val():null,AtmospherePoint:clickedOnRating?$("#hdatmospherePoint").val():null,DishesChosen:$("#hdDishesChosen").val(),Guest:$("#hdGuest").val(),MoneySpend:$("#hdMoneySpend").val(),VisitAgain:$("#hdVisitAgain").val(),RestaurantId:$("#hdRestaurantId").val(),RestaurantName:$("#hdRestaurantName").val(),YoutubeCode:$("#YoutubeCode").val(),hashtagsString:b,HasShareOnFacebook:$("#hdhasShareOnFacebook").val(),ShareOnFacebook:$("#hdshareOnFacebook").val(),IsPrivateFeedback:$("#hdprivateFeedback").val()};$("#btnSubmit").attr("disabled","disabled");var e="/Review/AddNewReview";$.ajax({url:e,type:"POST",data:d,success:function(a){if(a.Success==1){currentReviewID=a.ReviewId;if(typeof UploadReview.UploadReviewSuccessCallback=="undefined"||UploadReview.UploadReviewSuccessCallback==null)totalDoneCount>=0?AttachImg(a.ReviewId,isModifiedMode):(isModifiedMode?GetModifiedReview(a.ReviewId):GetNewReview(a.ReviewId),LoadReviewSummaryBox(UploadReview.CurrentRestaurantId));else{var b="",c=!1;isModifiedMode&&(b=getUploadPictureIds(),c=!0),$.post("/Upload/SaveReviewPictures",{reviewId:currentReviewID,restaurantId:UploadReview.CurrentRestaurantId,type:"other",tokenKey:tokenUploadKey,realPictureIds:b,editMode:c},function(){typeof widgetPostReviewSuccess=="function"&&widgetPostReviewSuccess(a),$.modal.close(),UploadReview.UploadReviewSuccessCallback(currentReviewID)})}}else $.each(a.ErrorList,function(a,b){$("#error-"+b.PropertyName).text(b.ErrorMessage)})},failure:function(a){alert(a)}})}else alert("Ảnh đang được tải vui lòng chờ!");return!1},UploadReview.LoadSuggestRestaurantForReview=function(a,b){var c=new Date;UploadReview.ShowLoadingDialog(),$.ajax({type:"GET",url:"/Common/IsLogin?"+c.getTime(),success:function(c){c.success==1?UploadReview.OpenSuggestRestaurantForm(a,b):LoginPopup.Show(function(){$.modal.close(),UploadReview.OpenSuggestRestaurantForm(a,b)},b)}})},UploadReview.OpenSuggestRestaurantForm=function(a,b){$.modal.close(),$("#suggest-restaurant-reviews-popup").modal({persist:!0}),UploadReview.SuggestedRestaurant==null?(UploadReview.SuggestedRestaurant=new SuggestedRestaurantModel(null),ko.applyBindings(UploadReview.SuggestedRestaurant,document.getElementById("selected-restaurant-to-review"))):(UploadReview.SuggestedRestaurant.data(null),UploadReview.SuggestedRestaurant.searchText(""),$("#txtResSearch").val(""))},UploadReview.SuggestedRestaurant=null;var SuggestedRestaurantModel=function(a){var b=this;b.data=ko.observable(a),b.searchText=ko.observable(""),b.loading=ko.observable(!1),b.writereview=function(){b.data()!=null&&UploadReview.LoadAddNewReviewForm(b.data().Id,function(a){$.modal.close(),window.location.href=b.data().Url+"/binh-luan-"+a},function(){UploadReview.LoadSuggestRestaurantForReview()})}};UploadReview.GetSuggestedRestaurant=function(a){if(!UploadReview.SuggestedRestaurant.loading()){UploadReview.SuggestedRestaurant.loading(!0);var b=new Date;$.get("/restaurant/GetBasicInfo?t="+b.getTime()+"&restaurantid="+a,function(a){a.success&&UploadReview.SuggestedRestaurant.data(a.data),UploadReview.SuggestedRestaurant.loading(!1)})}},$(".add-new-reviews").live("click",function(){UploadReview.LoadSuggestRestaurantForReview()}),$(function(){$("#txtResSearch").length>0&&($("#txtResSearch").autocomplete({delay:500,source:function(a,b){$.ajax({url:"/directory/suggestlist?limit=100&provinceId="+currentlocationid,dataType:"json",contentType:"application/json",type:"GET",data:{keyword:""+a.term+""},success:function(a){var c=a;b($.map(c,function(a){return{label:a.Name,value:a.Id,address:a.Address+", "+a.City,picturePath:a.PicturePath}}))}})},minLength:2,focus:function(a,b){return $(this).val(b.item.label),!1},select:function(a,b){return $(this).val(b.item.label),UploadReview.GetSuggestedRestaurant(b.item.value),!1},open:function(){$(this).removeClass("ui-corner-all").addClass("ui-corner-top")},close:function(){$(this).removeClass("ui-corner-top").addClass("ui-corner-all")}}).data("autocomplete")._renderItem=function(a,b){return $("<li class='lists-items'>").data("item.autocomplete",b).append('<a style="overflow:hidden;" class="lists-items-link"><img style="margin:2px;" align="left" src="'+b.picturePath+'" width="40px" />'+'<span style="display:block; float:left;margin-left:5px;width:460px;">'+b.label+'<br/><span class="lists-items-address" style="font-weight:normal;">'+b.address+"</span></span></a>").appendTo(a)})})
